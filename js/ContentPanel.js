import PDF from"./br/com/leedigital/justine/classroom/PDF.js";import Document from"./br/com/leedigital/justine/classroom/Document.js";import{UTIL}from"./br/com/leedigital/justine/classroom/util/Util.js";import ImageFile from"./br/com/leedigital/justine/classroom/ImageFile.js";import ScreenCapture from"./br/com/leedigital/justine/classroom/ScreenCapture.js";import ScreenCaptureElectron from"./br/com/leedigital/justine/classroom/ScreenCaptureElectron.js";import{Board}from"./br/com/leedigital/justine/classroom/Board.js";let recentColorIndex=0,recentColorElement=null;const attachImage=document.createElement("input");attachImage.type="file",attachImage.accept="image/*";export default class ContentPanel{constructor(){this.headerElement=this.contentElement=this.tooltipElement=this.pageElement=this.pageEndElement=this.lineWidthSliderThumbElement=this.eraserSliderThumbElement=this.opacityColorSliderThumbElement=this.boardElement=this.boardElementGearSettings=null,this.zoomSliderElement=this.pageStartElement=this.handEditElement=this.arrowEditElement=this.dashedArrowElement=this.lineEditElement=this.dashedLineEditElement=this.lineWidthSliderElement=this.colorPickerElement=this.eraserElement=this.eraserSliderElement=this.opacityColorSliderElement=null,this.document=null;const e=document.querySelector('div[data-ld-src="hdr-mst-pnl"'),t=document.querySelector('div[data-ld-src="cvs-pnl"]'),r=document.querySelector('label[data-ld-src="zoom-tooltip"]'),l=document.querySelector('div[data-ld-src="page-element"]'),n=e.querySelector('input[data-ld-src="sld-zoom"]'),o=document.querySelector('label[data-ld-src="line-width-slider-thumb"]'),a=l.querySelector('input[data-ld-src="page-start"]'),i=l.querySelector('label[data-ld-src="page-end"]'),s=e.querySelector('input[data-ld-src="input-hand-draw-edit"]'),d=e.querySelector('input[data-ld-src="input-arrow-draw-edit"]'),c=e.querySelector('input[data-ld-src="input-line-draw-edit"]'),u=e.querySelector('input[data-ld-src="dashed-line-draw-edit"]'),m=document.querySelector('input[data-ld-src="line-width-slider"]'),h=document.querySelector('input[data-ld-src="color-picker"]'),p=document.querySelector('input[data-ld-src="input-eraser-edit"]'),g=document.querySelector('input[data-ld-src="eraser-slider"]'),b=document.querySelector('label[data-ld-src="eraser-slider-thumb"]'),S=e.querySelector('input[data-ld-src="opacity-color-slider"]'),E=e.querySelector('label[data-ld-src="opacity-color-slider-thumb"]'),y=e.querySelector('span[data-ld-src="new-board"]'),C=document.querySelector('span[data-ld-src="gear-settings-master-panel"]');y.gearElement=y.querySelector('span[data-ld-src="new-board-gear"]'),y.gearElement.isShowing=()=>"inline-block"===this.boardElementGearSettings.style.display,C.onclick=e=>this.clickHandler(e),C.gearElement=C.querySelector('span[data-ld-src="new-board-gear"]'),Object.defineProperties(this,{headerElement:{get:()=>e},contentElement:{get:()=>t},tooltipElement:{get:()=>r},pageElement:{get:()=>l},pageStartElement:{get:()=>a},pageEndElement:{get:()=>i},zoomSliderElement:{get:()=>n},handEditElement:{get:()=>s},arrowEditElement:{get:()=>d},lineEditElement:{get:()=>c},dashedLineEditElement:{get:()=>u},lineWidthSliderThumbElement:{get:()=>o},lineWidthSliderElement:{get:()=>m},colorPickerElement:{get:()=>h},eraserElement:{get:()=>p},eraserSliderElement:{get:()=>g},eraserSliderThumbElement:{get:()=>b},opacityColorSliderElement:{get:()=>S},opacityColorSliderThumbElement:{get:()=>E},boardElement:{get:()=>y},boardElementGearSettings:{get:()=>C}}),e.onclick=this.clickHandler.bind(this),t.onmouseenter=e=>{e.target.focus()},t.onscroll=this.scrollHandler.bind(this),a.onkeyup=this.pageStartHandler.bind(this),this.zoomSliderElement.oninput=this.zoomHandler.bind(this),this.lineWidthSliderElement.oninput=this.lineWidthSliderHandler.bind(this),this.colorPickerElement.onchange=this.colorPickerHandler.bind(this),this.eraserSliderElement.oninput=this.eraserSliderHandler.bind(this),this.opacityColorSliderElement.oninput=this.opacityColorSliderHandler.bind(this),C.querySelector('input[id="boardName"]').onchange=e=>{const t=e.target;t instanceof HTMLInputElement&&this.board.load(t.value)},C.querySelector('input[id="width"]').oninput=e=>{this.board.resize(e.target.valueAsNumber)},C.querySelector('input[id="height"]').oninput=e=>{this.board.resize(null,e.target.valueAsNumber)},C.querySelector('input[id="backgroundColor"]').oninput=e=>{this.board.changeBackgroundColor(e.target.value)},C.querySelector('input[id="gridWidth"]').oninput=e=>{this.board.changeGridSize(e.target.valueAsNumber)},C.querySelector('input[id="gridHeight"]').oninput=e=>{this.board.changeGridSize(null,e.target.valueAsNumber)},C.querySelector('input[id="gridColor"]').oninput=e=>{this.board.changeGridColor(e.target.value)},C.querySelector('input[id="opacity"]').oninput=e=>{this.board.changeOpacity(e.target.valueAsNumber)},attachImage.onchange=e=>{const t=e.target.files[0];/.(png|gif|jpg|jpeg)$/.test(t.type)&&(this.board.attachImage(URL.createObjectURL(t)),attachImage.value=null)},this.zoomTooltipHandler(),this.lineWidthSliderHandler(),this.eraserSliderHandler(),this.opacityColorSliderHandler(),this.recentColorsArray=[...document.querySelectorAll('input[name="recent-color"]')];for(let e=0,t=this.recentColorsArray.length;e<t;e++)this.recentColorsArray[e].oninput=this.recentColorHandler.bind(this);recentColorElement=this.recentColorsArray[0].nextElementSibling;e.querySelector('span[data-ld-src="clear-page-panel"]').onclick=()=>{this.document&&this.document.clear(),this.board.isShowing()&&this.board.clear()},this.screenCapture=UTIL.desktop?new ScreenCaptureElectron:new ScreenCapture;const w=e.querySelector('input[id="cam"]'),v=e.querySelector('span[data-ld-src="rec-inner-panel"]'),q=e.querySelector('button[data-ld-src="rec-start-button"]'),f=e.querySelector('button[data-ld-src="rec-pause-button"]'),k=e.querySelector('button[data-ld-src="rec-stop-button"]');f.paused=!1;const x=q.textContent,H=f.textContent;let z=null;q.onclick=async()=>{if(await UTIL.isMicrophoneDenied())UTIL.showStatusBar("Para gravar um vídeo, você precisa permite acesso ao microfone");else try{await this.screenCapture.start(w.checked,(()=>(()=>{w.disabled=!0;let e=0,t=0,r=0,l="00",n="00",o="00";q.textContent=`Gravando ${o}:${n}:${l}`,z=setInterval((()=>{f.paused||(e++,e<10?l=`0${e}`:e>59?(e=0,l=`0${e}`,t++):l=e,t<10?n=`0${t}`:t>59?(t=0,n=`0${t}`,r++):n=t,o=r<10?`0${r}`:r,q.textContent=`Gravando ${o}:${n}:${l}`)}),1e3)})()))}catch(e){w.disabled=!1,this.screenCapture.reset(),q.textContent=x,UTIL.showStatusBar(e)}},f.onclick=()=>{this.screenCapture.capturing&&(f.paused?(this.screenCapture.resume(),f.paused=!1,f.textContent="Pausar"):(this.screenCapture.pause(),f.textContent="Retomar",f.paused=!0))},k.onclick=()=>{clearInterval(z),this.screenCapture.stop()},this.screenCapture.addStopHandler((()=>{clearInterval(z),w.disabled=!1,q.textContent=x,f.textContent=H,f.paused=!1,v.style.left=null})),document.addEventListener("keydown",(e=>{if(!e)return;if(!e.key)return;const t=e.key.toLowerCase();e.altKey?"enter"===t&&document.body.requestFullscreen():e.ctrlKey&&("q"===t?UTIL.closeElectronWindow():"i"===t?UTIL.openDevToolsFromElectronWindow():"f"===t&&UTIL.fullscreenFromElectronWindow())})),this.board=new Board(this),this.board.resize(C.querySelector('input[id="width"]').valueAsNumber,C.querySelector('input[id="height"]').valueAsNumber)}pageStartHandler(e){const t=e.target,r=this.document,l=e.key.toLowerCase();t&&r&&"enter"===l&&r.changePage(t.value-1)}scrollHandler(e){if(!this.document)return;e.preventDefault();const t=e.target;this.document.pageManager(t)}clickHandler(e){const t=e.target,r=t.getAttribute("data-ld-src");if("open-file-lbl"===r)this.openFileHandler(t.nextElementSibling);else if("zoom-out"===r){const e=this.zoomSliderElement,t=Number.parseFloat(e.min),r=Number.parseFloat(e.step),l=e.valueAsNumber-r;l>=t&&(e.value=l,this.zoomHandler())}else if("zoom-in"===r){const e=this.zoomSliderElement,t=Number.parseFloat(e.max),r=Number.parseFloat(e.step),l=e.valueAsNumber+r;l<=t&&(e.value=l,this.zoomHandler())}else if("new-board-new"===r){const e=this.boardElement.querySelector('span[data-ld-src="new-board-new"]');this.board.isShowing()?(this.board.hide(),e.setAttribute("data-ld-title","Abrir Lousa"),e.textContent="Abrir Lousa",this.boardElement.querySelector('span[data-ld-src="new-board-gear"]').innerHTML=null,this.boardElement.gearElement.isShowing()&&this.boardElement.gearElement.click()):(Document.currentDocument&&(this.zoomSliderElement.oldValue=this.zoomSliderElement.valueAsNumber),this.board.show(),this.zoomSliderElement.value=this.boardElement.zoom||1,this.zoomHandler(),e.setAttribute("data-ld-title","Fechar Lousa"),e.textContent="Fechar Lousa",this.boardElement.gearElement.innerHTML="&nbsp;&nbsp;⚙")}else if("new-board-gear"===r){const e=this.boardElementGearSettings.style;"none"===e.display||0===e.display.length?e.display="inline-block":e.display="none"}else if("gear-settings-checkbox-panel-grd"===r){const e=t.querySelector("input[type=checkbox]");e.checked?(e.checked=!1,this.board.hideGrid()):(e.checked=!0,this.board.showGrid())}else"gear-settings-input-panel-img"===r?attachImage.click():"datalist-name-gear"===r&&this.board.removePageSaved()}zoomTooltipHandler(){const e=this.tooltipElement,t=this.zoomSliderElement,r=74/(Number.parseFloat(t.max)-Number.parseFloat(t.min))*t.valueAsNumber;e.style.left=`${r}px`,e.textContent=t.value}lineWidthSliderHandler(){const e=this.lineWidthSliderThumbElement,t=this.lineWidthSliderElement,r=91/(Number.parseFloat(t.max)-Number.parseFloat(t.min))*t.valueAsNumber;e.style.left=`${r}px`,e.textContent=t.value}eraserSliderHandler(){const e=this.eraserSliderThumbElement,t=this.eraserSliderElement,r=91/(Number.parseFloat(t.max)-Number.parseFloat(t.min))*t.valueAsNumber;e.style.left=`${r}px`,e.textContent=t.value}opacityColorSliderHandler(){const e=this.opacityColorSliderThumbElement,t=this.opacityColorSliderElement,r=91/(Number.parseFloat(t.max)-Number.parseFloat(t.min))*t.valueAsNumber;e.style.left=`${r}px`,e.textContent=t.value}zoomHandler(){this.zoomTooltipHandler();const e=Document.currentDocument;if(e){e.update(),e===this.board&&(this.boardElement.zoom=this.zoomSliderElement.valueAsNumber);const t=this.pageStartElement.valueAsNumber||1;t&&setTimeout((()=>{e.changePage(t-1),this.zoomSliderElement.focus()}),1e3)}}openFileHandler(e){e.click(),e.onchange=e=>{this.board.isShowing()&&this.boardElement.querySelector('span[data-ld-src="new-board-new"]').click();const t=e.target,r=t.files[0],l=r.type,n=this,o=r.name;let a=null;l.endsWith("/pdf")?(a=new FileReader,a.onload=function(){UTIL.showProgressBar(),n.document=new PDF(new Uint8Array(this.result),n),n.document.title=o}):/\/(png|jpg|jpeg)$/gi.test(l)&&(a=new FileReader,a.onload=function(){UTIL.showProgressBar(),n.document=new ImageFile(new Uint8Array(this.result),n,l),n.document.title=o}),a&&a.readAsArrayBuffer(r),t.value=""}}colorPickerHandler(e){const t=e.target.value,r=this.recentColorsArray[recentColorIndex];r.checked=!0;const l=r.nextElementSibling;recentColorElement=l,l.style.backgroundColor=t,recentColorIndex++>6&&(recentColorIndex=0)}recentColorHandler(e){const t=e.target;t instanceof HTMLInputElement&&(recentColorIndex=this.recentColorsArray.indexOf(t),recentColorElement=e.target.nextElementSibling)}get currentColor(){return window.getComputedStyle(recentColorElement).backgroundColor}get zoom(){return this.zoomSliderElement.value}get eraser(){return this.eraserElement.checked}get opacityColorValue(){return this.opacityColorSliderElement.valueAsNumber/100}reset(){this.zoomSliderElement.value=this.zoomSliderElement.oldValue??1,this.zoomTooltipHandler()}}