import ContentPanel from"../../../../../ContentPanel.js";import Page from"./Page.js";import{UTIL}from"./util/Util.js";const _documentControl=[];export default class Document{static get documentControl(){return _documentControl}static get currentDocument(){return Document.documentControl[Document.documentControl.length-1]||null}constructor(arrayBuffer,contentPanel){Document.documentControl.push(this),this.contentPanel=null,this.title="",this.scrollTop=0,this.pages=[],Object.defineProperties(this,{contentPanel:{get:()=>contentPanel}}),this.init(arrayBuffer,contentPanel),window.addEventListener("keydown",evt=>{if(evt.ctrlKey){if(this!==Document.currentDocument)return;evt.preventDefault(),evt.stopImmediatePropagation();const currentPage=this.currentPage,s=83,arrowRight=39,arrowLeft=37,keyCode=evt.keyCode;if(evt.shiftKey)s===keyCode&&this.saveAll();else if(currentPage){const z=90,y=89,printScreen=44;switch(keyCode){case z:currentPage.undo();break;case y:currentPage.redo();break;case s:this.save();break;case printScreen:currentPage.screenshot.capture();break;case arrowRight:this.changePage(currentPage.number);break;case arrowLeft:this.changePage(currentPage.number-2)}}}})}init(arrayBuffer,contentPanel){}get headerElement(){return this.contentPanel.headerElement}get contentElement(){return this.contentPanel.contentElement}get innerContentElementPanel(){return this.contentElement.firstElementChild}get pageStartElement(){return this.contentPanel.pageStartElement}get pageHeight(){const element=this.innerContentElementPanel;return Math.floor(element.scrollHeight/this.pages.length)}get currentPage(){const index=this.contentPanel.pageStartElement.valueAsNumber-1;return index>=0&&index<this.pages.length?this.pages[index]:null}update(){const scale=this.contentPanel.zoom;for(const page of this.pages){page.scale=scale;const canvas=page.context2d.canvas,canvasLayer=page.context2dLayer.canvas;canvas.style.width=canvasLayer.style.width=`${canvas.width*scale}px`}}pageManager(element=null){if(this.contentPanel.pageEndElement.textContent=this.pages.length,element){const scroll=element.scrollTop,pageIndex=Math.floor(scroll/this.pageHeight)+1,pageHeight=this.pageHeight*pageIndex-this.contentElement.offsetHeight;this.pageStartElement.valueAsNumber=pageIndex;const pageLenth=this.pages.length,previousIndex=pageIndex-2,currentIndex=pageIndex-1,nextIndex=pageIndex;previousIndex>=0&&previousIndex<pageLenth&&scroll>this.pageHeight*previousIndex&&this.pages[previousIndex].hidden(),currentIndex>=0&&currentIndex<pageLenth&&this.pages[currentIndex].show(),element.scrollTop>pageHeight?nextIndex>=0&&nextIndex<pageLenth&&this.pages[nextIndex].show():nextIndex>0&&nextIndex<pageLenth&&this.pages[nextIndex].hidden()}}changePage(number){number>=0&&number<this.pages.length?this.pages[number].focus():(UTIL.alert("Número de página inválido "),this.pageManager(this.contentElement))}get isHandEdit(){return this.contentPanel.handEditElement.checked}get isArrowEdit(){return this.contentPanel.arrowEditElement.checked}get isLineEdit(){return this.contentPanel.lineEditElement.checked}get isDashedLineEdit(){return this.contentPanel.dashedLineEditElement.checked}get lineWidth(){return this.contentPanel.lineWidthSliderElement.valueAsNumber}get currentColor(){return this.contentPanel.currentColor}get eraser(){return this.contentPanel.eraser}get eraserLength(){return this.contentPanel.eraserSliderElement.valueAsNumber}get opacityColorValue(){return this.contentPanel.opacityColorValue}clear(){const page=this.currentPage;page&&(page.clear(),page.clearCache())}save(){const currentPage=this.currentPage;currentPage.save(),UTIL.showStatusBar("Página atual foi salva com sucesso"),console.log("saved current page")}saveAll(){const pages=this.pages;for(const page of pages)page.save();UTIL.showStatusBar("Todas as páginas foram salvas com sucesso"),console.log("saved all pages")}}