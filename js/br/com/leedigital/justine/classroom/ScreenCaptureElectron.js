import ScreenCapture from"./ScreenCapture.js";export default class ScreenCaptureElectron extends ScreenCapture{#constraints={audio:!1,video:{mandatory:{chromeMediaSource:"desktop"}}};constructor(){super()}async#startCapture(e,t){const a=this.anchor;a.style.display="none";const i=this.enableCamera;this.#constraints.video.mandatory.chromeMediaSourceId=e.id;const o=await navigator.mediaDevices.getUserMedia(this.#constraints),r=await navigator.mediaDevices.getUserMedia({video:i,audio:this.audioConstraints});this.video.srcObject=r,this.video.muted=!0;const s=new AudioContext(this.audioContextOptions),n=s.createMediaStreamDestination(),c=s.createMediaStreamSource(r),d=s.createGain();if(d.gain.value=1,c.connect(d).connect(n),o.getAudioTracks().length>0){const e=s.createMediaStreamSource(o),t=s.createGain();t.gain.value=1,e.connect(t).connect(n)}const u=[...o.getVideoTracks(),...n.stream.getAudioTracks()],h=new MediaStream(u);this.mediaRecorder=new MediaRecorder(h),h.getVideoTracks()[0].onended=()=>{this.stop()};const m=[];this.mediaRecorder.ondataavailable=function(e){m.push(e.data)},this.mediaRecorder.onstop=()=>{let e=o.getTracks();e.forEach((e=>e.stop())),e=r.getTracks(),e.forEach((e=>e.stop())),this.video.srcObject=null;const t=new Blob(m,{mimeType:"video/mp4"});m.length=0,a.href=window.URL.createObjectURL(t),a.download=this.fileName,a.click(),this.mediaRecorder=null},this.mediaRecorder.onpause=()=>{this.paused=!0},this.mediaRecorder.onresume=()=>{this.paused=!1},this.mediaRecorder.start(),this.capturing=!0,t&&t()}#onClickMenu(e,t){this.#startCapture(e,t)}async start(e,t=new Function){if(!this.capturing){this.enableCamera=e;const{desktopCapturer:a,remote:i}=require("electron"),{Menu:o}=i,r=[];a.getSources({types:["window","screen"]}).then((async e=>{for(const a of e)r.push({label:a.name,click:()=>this.#onClickMenu(a,t)});o.buildFromTemplate(r).popup()}))}}}