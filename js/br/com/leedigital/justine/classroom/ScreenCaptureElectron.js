import ScreenCapture from"./ScreenCapture.js";export default class ScreenCaptureElectron extends ScreenCapture{#constraints={audio:!1,video:{mandatory:{chromeMediaSource:"desktop"}}};#capture=!1;constructor(){super()}get capturing(){return this.#capture}set capturing(e){this.#capture=e}async#startCapture(e,t){const a=this.anchor;a.style.display="none";const i=this.enableCamera;this.#constraints.video.mandatory.chromeMediaSourceId=e.id;const r=await navigator.mediaDevices.getUserMedia(this.#constraints),o=await navigator.mediaDevices.getUserMedia({video:i,audio:this.audioConstraints});this.video.srcObject=o,this.video.muted=!0;const s=new AudioContext(this.audioContextOptions),n=s.createMediaStreamDestination(),c=s.createMediaStreamSource(o),d=s.createGain();if(d.gain.value=1,c.connect(d).connect(n),r.getAudioTracks().length>0){const e=s.createMediaStreamSource(r),t=s.createGain();t.gain.value=1,e.connect(t).connect(n)}const u=[...r.getVideoTracks(),...n.stream.getAudioTracks()],h=new MediaStream(u);this.mediaRecorder=new MediaRecorder(h),h.getVideoTracks()[0].onended=()=>{this.stop()};const p=[];this.mediaRecorder.ondataavailable=function(e){p.push(e.data)},this.mediaRecorder.onstop=()=>{let e=r.getTracks();e.forEach((e=>e.stop())),e=o.getTracks(),e.forEach((e=>e.stop())),this.video.srcObject=null;const t=new Blob(p,{mimeType:"video/mp4"});p.length=0,a.href=window.URL.createObjectURL(t),a.download=this.fileName,a.click(),this.mediaRecorder=null},this.mediaRecorder.onpause=()=>{this.paused=!0},this.mediaRecorder.onresume=()=>{this.paused=!1},this.mediaRecorder.start(),this.capturing=!0,t&&t()}#onClickMenu(e,t){this.#startCapture(e,t)}async start(e=new Function){if(!this.capturing){const{desktopCapturer:t,remote:a}=require("electron"),{Menu:i}=a,r=[];t.getSources({types:["window","screen"]}).then((async t=>{for(const a of t)r.push({label:a.name,click:()=>this.#onClickMenu(a,e)});i.buildFromTemplate(r).popup()}))}}}