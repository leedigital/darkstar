export default class ScreenCapture{mediaRecorder=null;anchor=document.querySelector('a[data-ld-title="download-anchor-element"]');video=document.querySelector('video[data-ld-src="cam-video-element"]');paused=!1;capture=!1;_map=new Map;constructor(){this.enableCamera=!1;const camVideoPanelElement=document.querySelector('span[data-ld-src="cam-video-panel"]'),style=camVideoPanelElement.style,mouse={x:1/0,y:1/0,drag:!1};camVideoPanelElement.onmousedown=evt=>{mouse.drag=!0},window.addEventListener("mousemove",evt=>{const target=evt.target;target instanceof HTMLVideoElement&&"cam-video-element"===target.getAttribute("data-ld-src")&&evt.preventDefault();const rect=camVideoPanelElement.getBoundingClientRect(),x=evt.x-.5*rect.width,y=evt.y-.5*rect.height;mouse.drag&&(style.left=`${x}px`,style.top=`${y}px`)}),camVideoPanelElement.onmouseup=camVideoPanelElement.onmouseout=camVideoPanelElement.onmouseleave=evt=>{mouse.drag=!1}}addStopHandler(handler){const map=this._map,handlers=map.get("stop");handlers?handlers.push(handler):map.set("stop",[handler])}fireEvent(evt){const handlers=this._map.get(evt);if(handlers)for(let i=handlers.length-1;i>=0;i--){const handler=handlers[i];handler(this)}}async start(){if(!this.capture){const anchor=this.anchor;anchor.style.display="none",this.capture=!0;const enableCamera=this.enableCamera,cameraAndAudioStream=await navigator.mediaDevices.getUserMedia({video:enableCamera,audio:{echoCancellation:!0}}),desktopMediaStream=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!1});this.video.srcObject=cameraAndAudioStream,this.video.muted=!0;const context=new AudioContext,destination=context.createMediaStreamDestination(),sourceAudio=context.createMediaStreamSource(cameraAndAudioStream),gain=context.createGain();gain.gain.value=1,sourceAudio.connect(gain).connect(destination);const tracks=[...desktopMediaStream.getVideoTracks(),...destination.stream.getAudioTracks()],stream=new MediaStream(tracks);this.mediaRecorder=new MediaRecorder(stream),stream.getVideoTracks()[0].onended=()=>{this.stop()};const chunks=[];this.mediaRecorder.ondataavailable=function(evt){chunks.push(evt.data)},this.mediaRecorder.onstop=()=>{console.log("stopping capture");let tracks=desktopMediaStream.getTracks();tracks.forEach(track=>track.stop()),tracks=cameraAndAudioStream.getTracks(),tracks.forEach(track=>track.stop()),this.video.srcObject=null;const blob=new Blob(chunks,{mimeType:"video/mp4"});chunks.length=0,anchor.href=window.URL.createObjectURL(blob),anchor.download="video.mp4",anchor.click(),this.mediaRecorder=null},this.mediaRecorder.onpause=()=>{this.paused=!0},this.mediaRecorder.onresume=()=>{this.paused=!1},this.mediaRecorder.start()}}pause(){this.capture&&this.mediaRecorder.pause()}async resume(){this.capture&&this.mediaRecorder.resume()}stop(){this.capture&&(this.capture=!1,this.mediaRecorder.stop(),this.anchor.style.display="inline-block",this.fireEvent("stop"))}reset(){this.capture=!1}get capturing(){return this.capture}get paused(){return this.paused}}