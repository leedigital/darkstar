export default class ScreenCapture{mediaRecorder=null;anchor=document.querySelector('a[data-ld-title="download-anchor-element"]');video=document.querySelector('video[data-ld-src="cam-video-element"]');paused=!1;#capture=!1;#audioConstraints={echoCancellation:!0,noiseSuppression:!0,sampleRate:44100};#audioContextOptions={latencyHint:0};#map=new Map;constructor(){this.enableCamera=!1;const e=document.querySelector('span[data-ld-src="cam-video-panel"]'),t=e.style,i={x:1/0,y:1/0,drag:!1},a=e.querySelector("video");a.onleavepictureinpicture=t=>{e.style.visibility=null},e.tabIndex=-1,e.ondblclick=t=>{document.pictureInPictureEnabled&&a.played.length&&(document.pictureInPictureElement?document.exitPictureInPicture():(a.requestPictureInPicture(),e.style.visibility="hidden"))};e.onkeydown=t=>{const i=t.key;"+"===i?(e.style.width=`${e.offsetWidth+3}px`,e.style.height=`${e.offsetWidth+3}px`):"-"===i&&(e.style.width=e.offsetWidth-3+"px",e.style.height=e.offsetWidth-3+"px")},e.onpointerdown=t=>{i.drag=!0,t.target.setPointerCapture(t.pointerId),e.focus()},e.onpointermove=a=>{const n=e.getBoundingClientRect(),o=a.x-.5*n.width,r=a.y-.5*n.height;i.drag&&(t.left=`${o}px`,t.top=`${r}px`)},e.onpointerup=e.onpointerout=e.onpointerleave=e=>{i.drag=!1,e.target.releasePointerCapture(e.pointerId)}}get fileName(){return`video_${Intl.DateTimeFormat("pt-BR",{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",hour12:!1}).format(new Date)}_.mp4`}addStopHandler(e){const t=this.#map,i=t.get("stop");i?i.push(e):t.set("stop",[e])}fireEvent(e){const t=this.#map.get(e);if(t)for(let e=t.length-1;e>=0;e--){(0,t[e])(this)}}get audioConstraints(){return this.#audioConstraints}get audioContextOptions(){return this.#audioContextOptions}async start(e=new Function){if(!this.capturing){const t=this.anchor;t.style.display="none";const i=this.enableCamera,a=this.audioConstraints,n=await navigator.mediaDevices.getUserMedia({video:i,audio:a}),o=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:a});this.video.srcObject=n,this.video.muted=!0;const r=new AudioContext(this.audioContextOptions),s=r.createMediaStreamDestination(),c=r.createMediaStreamSource(n),d=r.createGain();if(d.gain.value=1,c.connect(d).connect(s),o.getAudioTracks().length>0){const e=r.createMediaStreamSource(o),t=r.createGain();t.gain.value=1,e.connect(t).connect(s)}const u=[...o.getVideoTracks(),...s.stream.getAudioTracks()],p=new MediaStream(u);this.mediaRecorder=new MediaRecorder(p),p.getVideoTracks()[0].onended=()=>{this.stop()};const l=[];this.mediaRecorder.ondataavailable=function(e){l.push(e.data)},this.mediaRecorder.onstop=()=>{let e=o.getTracks();e.forEach((e=>e.stop())),e=n.getTracks(),e.forEach((e=>e.stop())),this.video.srcObject=null;const i=new Blob(l,{mimeType:"video/mp4"});l.length=0,t.href=window.URL.createObjectURL(i),t.download=this.fileName,t.click(),this.mediaRecorder=null},this.mediaRecorder.onpause=()=>{this.paused=!0},this.mediaRecorder.onresume=()=>{this.paused=!1},this.mediaRecorder.start(),this.capturing=!0,e&&e()}}pause(){this.capturing&&this.mediaRecorder.pause()}async resume(){this.capturing&&this.mediaRecorder.resume()}stop(){this.capturing&&(this.capturing=!1,this.mediaRecorder.stop(),this.anchor.style.display="inline-block",this.fireEvent("stop"))}reset(){this.capturing=!1}get capturing(){return this.#capture}set capturing(e){this.#capture=e}get paused(){return this.paused}}