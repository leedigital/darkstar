import ContentPanel from"../../../../../ContentPanel.js";import Document from"./Document.js";import{justineDB}from"./JustineDB.js";import Page from"./Page.js";import{UTIL}from"./util/Util.js";export class Board extends Document{#showGrid=!1;#showing=!1;#gridColor="#fff";#tileSizeY=32;#tileSizeX=32;#backgroundColor="#000";#mouse={x:1/0,y:1/0,drag:!1,grabbing:!1};#selectedImageBoard=null;#imagesBoard=[];#page=null;#leftEdge=!1;#datalistPrefix="_datalist_";#inputBoardNameElement;#datalistElement;#labelSave=" salvo em ";constructor(e){super(null,e),this.init2(e),Board.documentControl.pop(),this.#datalistElement=e.boardElementGearSettings.querySelector('datalist[id="ids"]'),this.#inputBoardNameElement=e.boardElementGearSettings.querySelector('input[id="boardName"]'),justineDB.on("init",(()=>{this.#loadBoardNamesFromStorage()}))}#loadBoardNamesFromStorage(){justineDB.listAllKeys("page",(e=>{const t=document.createDocumentFragment();this.#datalistElement.innerHTML=null;for(let i of e)if(i.startsWith(this.#datalistPrefix)){i=i.slice(this.#datalistPrefix.length).replace("_",this.#labelSave);const e=document.createElement("option");e.value=i,t.appendChild(e)}this.#datalistElement.appendChild(t)}))}#normalizeDocTitleToStorage(){this.title=this.title.replace(this.#labelSave,"_")}save(){this.title=this.#datalistPrefix+(this.#inputBoardNameElement.value||"board");const e=Intl.DateTimeFormat("pt-BR").format(new Date),t=this.title.indexOf(this.#labelSave);-1!==t&&(this.#normalizeDocTitleToStorage(),super.removePageSaved(),this.title=this.title.slice(0,t)),this.title=`${this.title}_${e}`,super.save(),this.#loadBoardNamesFromStorage()}removePageSaved(){this.#inputBoardNameElement.value&&(this.#normalizeDocTitleToStorage(),super.removePageSaved(),this.#inputBoardNameElement.value=null,this.#loadBoardNamesFromStorage(),this.clear(),UTIL.success())}load(e){this.title=this.#datalistPrefix+e,this.#normalizeDocTitleToStorage(),this.#page.clear(),this.restore(),this.update(),this.update2()}show(){this.#showing=!0;this.innerContentElementPanel.appendChild(this.#page.pageElement);const e=this.#page.pageElement.style;e.top=`${this.contentElement.scrollTop}px`,e.left=`${this.contentElement.scrollLeft}px`,this.contentElement.style.overflow="hidden",Board.documentControl.push(this),this.pageManager(this.contentElement)}hide(){if(this.innerContentElementPanel.contains(this.#page.pageElement)){this.#showing=!1,this.innerContentElementPanel.removeChild(this.#page.pageElement),this.contentPanel.reset(),this.contentElement.style.overflow=null,Board.documentControl.pop();const e=Board.currentDocument;e&&e.pageManager(e.contentElement)}}isShowing(){return this.#showing}changeOpacity(e){this.#page.pageElement.style.opacity=""+e/100}resize(e,t){const i=this.#page,s=i.context2dLayer.canvas,a=i.context2d.canvas;a.width=s.width=e||a.width,a.height=s.height=t||a.height,this.contentPanel.zoomHandler(),this.changeBackgroundColor(this.#backgroundColor),this.isShowing()&&this.currentPage.update()}showGrid(){this.#showGrid=!0;const e=this.#page.context2d,t=e.canvas,i=t.width,s=t.height;e.save(),e.fillRect(0,0,i,s),e.strokeStyle=this.#gridColor,e.lineWidth=.3;const a=this.#tileSizeY,o=this.#tileSizeX;for(let t=0,o=s/a,n=0;t<o;t++,n+=a)e.beginPath(),e.moveTo(0,n),e.lineTo(i,n),e.closePath(),e.stroke();for(let t=0,a=i/o,n=0;t<a;t++,n+=o)e.beginPath(),e.moveTo(n,0),e.lineTo(n,s),e.closePath(),e.stroke();e.restore(),this.drawImage()}hideGrid(){this.#showGrid=!1;const e=this.#page.context2d,t=e.canvas;e.fillRect(0,0,t.width,t.height),this.drawImage()}isShowingGrid(){return this.#showGrid}changeGridColor(e){this.#gridColor=e,this.update2()}changeGridSize(e,t){this.#tileSizeX=e||this.#tileSizeX,this.#tileSizeY=t||this.#tileSizeY,this.update2()}changeBackgroundColor(e){const t=this.#page.context2d,i=t.canvas;this.#backgroundColor=e,t.fillStyle=e,t.fillRect(0,0,i.width,i.height),this.update2()}init2(e){const t=this.pages,i=this;i.pageStartElement.min=1,i.pageStartElement.max=1;const s=this.#page=new Page(i,{pageNumber:i.pageNumber,pageIndex:i.pageIndex,getViewport:()=>({width:3072,height:2304}),render(e){e.canvasContext.fillRect(0,0,3072,2304)}});t.push(s),s.render(3),UTIL.hiddenProgressBar(),document.addEventListener("mousemove",(e=>this.mouseMove(e))),document.addEventListener("dblclick",(e=>this.doubleClick(e))),document.addEventListener("mouseup",(e=>this.mouseUp(e))),document.addEventListener("mouseleave",(e=>this.mouseUp(e))),document.addEventListener("mousedown",(e=>this.mouseDown(e))),document.addEventListener("keydown",(e=>this.keyDow(e))),document.addEventListener("keyup",(e=>this.keyUp(e))),this.contentElement.addEventListener("scroll",(e=>this.scroll(e)));const a=this.#page.pageElement.style;a.position="absolute",a.zIndex="999"}get currentPage(){return this.#page}scroll(e){const t=e.target;if(t instanceof HTMLDivElement&&this.isShowing()){e.preventDefault(),e.stopImmediatePropagation();const i=this.#page.pageElement.style;i.left=`${t.scrollLeft}px`,i.top=`${t.scrollTop}px`}}keyDow(e){if(!e.key)return;const t=e.key.toLowerCase();if("delete"===t&&e.shiftKey){const e=this.#imagesBoard.indexOf(this.#selectedImageBoard);-1!==e&&(this.#imagesBoard.splice(e,1).length>0&&(this.#selectedImageBoard=null),this.update2())}else" "===t&&(document.body.style.cursor="grabbing",this.#page.grabbing=this.#mouse.grabbing=!0)}keyUp(e){if(!e.key)return;" "===e.key.toLowerCase()&&(document.body.style.cursor="default",this.#page.grabbing=this.#mouse.grabbing=!1)}mouseDown(e){const t=this.#mouse;if(this.selectImageBoard(),this.#selectedImageBoard){if(this.#leftEdge)return this.#leftEdge=!1,void this.update2();const i=this.#selectedImageBoard,s=t.x,a=t.y,o=this.#page.context2d;e.ctrlKey?this.drawRect(i.x1,i.y1,i.width,i.height):this.update2(),i.leftPath&&o.isPointInPath(i.leftPath,s,a)&&(this.#leftEdge=!0)}}doubleClick(e){const t=e.target;if(t instanceof HTMLCanvasElement){if(t.getAttribute("data-ld-src")!==this.#page.context2d.canvas.getAttribute("data-ld-src"))return;this.selectImageBoard();const e=this.#selectedImageBoard;if(e){this.#mouse.drag=!0,this.drawRect(e.x1,e.y1,e.width,e.height),document.body.style.cursor="move"}}}selectImageBoard(){const e=this.#mouse;for(let t=0,i=this.#imagesBoard.length;t<i;t++){const i=this.#imagesBoard[t],s=e.x,a=e.y;s>i.x1&&s<i.x1+i.width&&a>i.y1&&a<i.y1+i.height&&(this.#selectedImageBoard=i)}}mouseUp(e){const t=e.target;if(t instanceof HTMLCanvasElement){if(t.getAttribute("data-ld-src")!==this.#page.context2d.canvas.getAttribute("data-ld-src"))return;this.#mouse.drag=!1,document.body.style.cursor="default"}}mouseMove(e){const t=e.target;if(t instanceof HTMLCanvasElement){if(t.getAttribute("data-ld-src")!==this.#page.context2d.canvas.getAttribute("data-ld-src"))return;const i=this.#page.context2d.canvas.getBoundingClientRect(),s=e.x-i.x,a=e.y-i.y,o=this.#mouse,n=1/this.contentPanel.boardElement.zoom;if(o.x=s*n,o.y=a*n,o.drag){if(this.#selectedImageBoard){const t=this.#selectedImageBoard;t.x1+=e.movementX,t.y1+=e.movementY,this.update2(),this.drawRect(t.x1,t.y1,t.width,t.height)}}else{if(this.#page.grabbing){const t=this.#page.pageElement,i=t.style;return i.left=`${t.offsetLeft+e.movementX}px`,void(i.top=`${t.offsetTop+e.movementY}px`)}const t=this.#selectedImageBoard;this.#leftEdge&&(t.width-=7*Math.sign(e.movementX),t.height-=7*Math.sign(e.movementX),this.update2(),this.drawRect(t.x1,t.y1,t.width,t.height))}}}update2(){this.isShowingGrid()?this.showGrid():this.hideGrid(),this.drawImage()}drawImage(){const e=this.#page.context2d;for(let t=0,i=this.#imagesBoard.length;t<i;t++){const i=this.#imagesBoard[t];e.drawImage(i,i.x1,i.y1,i.width,i.height)}}attachImage(e){const t=new ImageBoard;t.load(e,(()=>{this.#imagesBoard.push(t),this.update2()}))}drawRect(e,t,i,s){const a=this.#page.context2d;a.save(),a.strokeRect(e,t,i,s);const o=new Path2D;this.#selectedImageBoard.leftPath=o,o.rect(e,t,32,32),o.closePath(),a.stroke(o),a.restore()}}class ImageBoard extends Image{constructor(e,t){super(e,t),this.x1=0,this.y1=0}load(e,t){this.onload=()=>{t()},this.src=e}}