import ContentPanel from"../../../../../ContentPanel.js";import Document from"./Document.js";import Page from"./Page.js";import{UTIL}from"./util/Util.js";export class Board extends Document{_showGrid=!1;_showing=!1;_gridColor="#fff";_tileSizeY=32;_tileSizeX=32;_backgroundColor="#000";_mouse={x:1/0,y:1/0,drag:!1,grabbing:!1};_selectedImageBoard=null;_imagesBoard=[];_page=null;_leftEdge=!1;constructor(contentPanel){super(null,contentPanel),this.init2(contentPanel),Board.documentControl.pop()}show(){this._showing=!0;const innerContentElementPanel=this.innerContentElementPanel;innerContentElementPanel.appendChild(this._page.pageElement);const style=this._page.pageElement.style;style.top=`${this.contentElement.scrollTop}px`,style.left=`${this.contentElement.scrollLeft}px`,this.contentElement.style.overflow="hidden",Board.documentControl.push(this),this.pageManager(this.contentElement)}hide(){if(this.innerContentElementPanel.contains(this._page.pageElement)){this._showing=!1,this.innerContentElementPanel.removeChild(this._page.pageElement),this.contentPanel.reset(),this.contentElement.style.overflow=null,Board.documentControl.pop();const document=Board.currentDocument;document&&document.pageManager(document.contentElement)}}isShowing(){return this._showing}changeOpacity(value){this._page.pageElement.style.opacity=`${value/100}`}resize(width,height){const page=this._page,canvasLayer=page.context2dLayer.canvas,canvas=page.context2d.canvas;canvas.width=canvasLayer.width=width||canvas.width,canvas.height=canvasLayer.height=height||canvas.height,this.changeBackgroundColor(this._backgroundColor)}showGrid(){this._showGrid=!0;const context2d=this._page.context2d,canvas=context2d.canvas,width=canvas.width,height=canvas.height;context2d.save(),context2d.fillRect(0,0,width,height),context2d.strokeStyle=this._gridColor,context2d.lineWidth=.3;const tileSizeY=this._tileSizeY,tileSizeX=this._tileSizeX;for(let row=0,rowLen=height/tileSizeY,y=0;row<rowLen;row++,y+=tileSizeY)context2d.beginPath(),context2d.moveTo(0,y),context2d.lineTo(width,y),context2d.closePath(),context2d.stroke();for(let col=0,colLen=width/tileSizeX,x=0;col<colLen;col++,x+=tileSizeX)context2d.beginPath(),context2d.moveTo(x,0),context2d.lineTo(x,height),context2d.closePath(),context2d.stroke();context2d.restore(),this.drawImage()}hideGrid(){this._showGrid=!1;const context2d=this._page.context2d,canvas=context2d.canvas;context2d.fillRect(0,0,canvas.width,canvas.height),this.drawImage()}isShowingGrid(){return this._showGrid}changeGridColor(color){this._gridColor=color,this.update2()}changeGridSize(width,height){this._tileSizeX=width||this._tileSizeX,this._tileSizeY=height||this._tileSizeY,this.update2()}changeBackgroundColor(color){const context2d=this._page.context2d,canvas=context2d.canvas;this._backgroundColor=color,context2d.fillStyle=color,context2d.fillRect(0,0,canvas.width,canvas.height),this.update2()}init2(contentPanel){const pages=this.pages,thiz=this,scale=3;this.pageStartElement.min=1,this.pageStartElement.max=1;const width=3072,height=2304,page=this._page=new Page(this,{pageNumber:this.pageNumber,pageIndex:this.pageIndex,getViewport:()=>({width:3072,height:2304}),render(renderingContext){const context2d=renderingContext.canvasContext;context2d.fillRect(0,0,3072,2304)}});page.title=this.title,pages.push(page),page.render(3),UTIL.hiddenProgressBar(),page.restore(),document.addEventListener("mousemove",evt=>this.mouseMove(evt)),document.addEventListener("dblclick",evt=>this.doubleClick(evt)),document.addEventListener("mouseup",evt=>this.mouseUp(evt)),document.addEventListener("mouseleave",evt=>this.mouseUp(evt)),document.addEventListener("mousedown",evt=>this.mouseDown(evt)),document.addEventListener("keydown",evt=>this.keyDow(evt)),document.addEventListener("keyup",evt=>this.keyUp(evt)),this.contentElement.addEventListener("scroll",evt=>this.scroll(evt));const style=this._page.pageElement.style;style.position="absolute",style.zIndex="999"}get currentPage(){return this._page}scroll(evt){const target=evt.target;if(target instanceof HTMLDivElement&&this.isShowing()){evt.preventDefault(),evt.stopImmediatePropagation();const element=this._page.pageElement,style=element.style;style.left=`${target.scrollLeft}px`,style.top=`${target.scrollTop}px`}}keyDow(evt){const key=evt.key.toLowerCase(),space=" ";if("delete"===key&&evt.shiftKey){const offset=this._imagesBoard.indexOf(this._selectedImageBoard);-1!==offset&&(this._imagesBoard.splice(offset,1).length>0&&(this._selectedImageBoard=null),this.update2())}else" "===key&&(document.body.style.cursor="grabbing",this._page.grabbing=this._mouse.grabbing=!0)}keyUp(evt){const key=evt.key.toLowerCase(),space=" ";" "===key&&(document.body.style.cursor="default",this._page.grabbing=this._mouse.grabbing=!1)}mouseDown(evt){const mouse=this._mouse;if(this.selectImageBoard(),this._selectedImageBoard){if(this._leftEdge)return this._leftEdge=!1,void this.update2();const image=this._selectedImageBoard,x=mouse.x,y=mouse.y,context2d=this._page.context2d;evt.ctrlKey?this.drawRect(image.x1,image.y1,image.width,image.height):this.update2(),image.leftPath&&context2d.isPointInPath(image.leftPath,x,y)&&(this._leftEdge=!0)}}doubleClick(evt){const element=evt.target;if(element instanceof HTMLCanvasElement){if(element.getAttribute("data-ld-src")!==this._page.context2d.canvas.getAttribute("data-ld-src"))return;this.selectImageBoard();const image=this._selectedImageBoard;if(image){const mouse=this._mouse;mouse.drag=!0,this.drawRect(image.x1,image.y1,image.width,image.height),document.body.style.cursor="move"}}}selectImageBoard(){const mouse=this._mouse;for(let i=0,len=this._imagesBoard.length;i<len;i++){const image=this._imagesBoard[i],x=mouse.x,y=mouse.y;x>image.x1&&x<image.x1+image.width&&y>image.y1&&y<image.y1+image.height&&(this._selectedImageBoard=image)}}mouseUp(evt){const element=evt.target;if(element instanceof HTMLCanvasElement){if(element.getAttribute("data-ld-src")!==this._page.context2d.canvas.getAttribute("data-ld-src"))return;this._mouse.drag=!1,document.body.style.cursor="default"}}mouseMove(evt){const element=evt.target;if(element instanceof HTMLCanvasElement){if(element.getAttribute("data-ld-src")!==this._page.context2d.canvas.getAttribute("data-ld-src"))return;const rect=this._page.context2d.canvas.getBoundingClientRect(),x=evt.x-rect.x,y=evt.y-rect.y,mouse=this._mouse;if(mouse.x=x,mouse.y=y,mouse.drag){if(this._selectedImageBoard){const image=this._selectedImageBoard;image.x1+=evt.movementX,image.y1+=evt.movementY,this.update2(),this.drawRect(image.x1,image.y1,image.width,image.height)}}else{if(this._page.grabbing){const element=this._page.pageElement,style=element.style;return style.left=`${element.offsetLeft+evt.movementX}px`,void(style.top=`${element.offsetTop+evt.movementY}px`)}const image=this._selectedImageBoard;this._leftEdge&&(image.width-=7*Math.sign(evt.movementX),image.height-=7*Math.sign(evt.movementX),this.update2(),this.drawRect(image.x1,image.y1,image.width,image.height))}}}update2(){this.isShowingGrid()?this.showGrid():this.hideGrid(),this.drawImage()}drawImage(){const context2d=this._page.context2d;for(let i=0,len=this._imagesBoard.length;i<len;i++){const image=this._imagesBoard[i];context2d.drawImage(image,image.x1,image.y1,image.width,image.height)}}clear(){const canvas=this._page.context2dLayer.canvas;this._page.context2dLayer.clearRect(0,0,canvas.width,canvas.height)}attachImage(src){const image=new ImageBoard;image.load(src,()=>{this._imagesBoard.push(image),this.update2()})}drawRect(x,y,w,h){const context2d=this._page.context2d;context2d.save(),context2d.strokeRect(x,y,w,h);const leftPath=new Path2D,width=32,height=32;this._selectedImageBoard.leftPath=leftPath,leftPath.rect(x,y,32,32),leftPath.closePath(),context2d.stroke(leftPath),context2d.restore()}}class ImageBoard extends Image{constructor(width,height){super(width,height),this.x1=0,this.y1=0}load(src,callback){this.onload=()=>{callback()},this.src=src}}