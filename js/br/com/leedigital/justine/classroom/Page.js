import Document from"./Document.js";import{MOUSE}from"./util/Mouse.js";import{UTIL}from"./util/Util.js";import Screenshot from"./Screenshot.js";const point={x:0,y:0},arrrowObject={x:0,y:0,start:!1};let lock=!1,_grabbing=!1;export default class Page{constructor(t,e){this.title="",this.document=null,this.pageElement=null,this.context2d=this.context2dLayer=null,this.pageObject=null,this.number=0,this.height=0,this.width=0,this.drag=!1;const i=window.document,s=i.createElement("div");s.tabIndex=-1,s.setAttribute("data-ld-src",`page-panel-${e.pageNumber}`);const n=i.createElement("span");n.style="position: relative; display:inline-block";const o=i.createElement("canvas");o.setAttribute("data-ld-src",`canvas-render-${e.pageNumber}`);const h=o.getContext("2d"),r=i.createElement("canvas");r.ontouchstart=t=>{const e=t.touches[0];t.preventDefault(),this.focus(),r.dispatchEvent(new MouseEvent("mousedown",{clientX:e.clientX,clientY:e.clientY}))},r.ontouchmove=t=>{const e=t.touches[0];t.preventDefault(),r.dispatchEvent(new MouseEvent("mousemove",{clientX:e.clientX,clientY:e.clientY}))},r.ontouchend=t=>{t.preventDefault(),r.dispatchEvent(new MouseEvent("mouseup",{}))},r.onmousedown=this.onmousedown.bind(this),r.onmouseup=this.onmouseup.bind(this),r.onmousemove=this.onmousemove.bind(this),r.onmouseleave=this.onmouseleave.bind(this),r.setAttribute("data-ld-src",`canvas-render-${e.pageNumber}`),r.style="position:absolute; left:0px; top: 0px;";const a=r.getContext("2d");n.appendChild(o),n.appendChild(r),s.appendChild(n),Object.defineProperties(this,{document:{get:()=>t},pageElement:{get:()=>s},context2d:{get:()=>h},context2dLayer:{get:()=>a},pageObject:{get:()=>e},number:{get:()=>e.pageNumber},pageIndex:{get:()=>e.pageIndex},height:{get:()=>o.height},width:{get:()=>o.width}}),this.scale=1,this.history=null,this.undoStartFlag=!1,this.undoClearFlag=!1,this.undoHistory=[],this.redoHistory=[],this.screenshot=new Screenshot(this),this.hidden()}show(){}hidden(){}focus(){this.pageElement.focus()}render(t){const e=this.pageObject;this.scale=t=Math.max(window.outerWidth/e.getViewport({scale:1}).width,e.getViewport({scale:1}).width/window.outerWidth);const i=e.getViewport({scale:.99*t.toFixed(1)}),s=this.context2d,n=s.canvas,o=this.context2dLayer.canvas;o.height=n.height=i.height,o.width=n.width=i.width;const h={canvasContext:s,viewport:i};e.render(h)}redo(){const t=this.redoHistory;if(t.length>0){if(lock)return;lock=!0;const e=t.pop();this.undoHistory.push(e),e.run(),lock=!1}else UTIL.alert("Não existem ações a serem refeitas")}undo(){const t=this.undoHistory;if(t.length>0){if(lock)return;lock=!0,this.undoClearFlag&&(this.undoClearFlag=!1);const e=t.pop();e instanceof Clean||(this.clear(),this.redoHistory.push(e),this.undoStartFlag=!0);for(const e of t)e.run();lock=!1}else UTIL.alert("Não existem ações a serem desfeitas")}update(){this.clear();for(let t=0,e=this.undoHistory.length;t<e;t++){const e=this.undoHistory[t];e instanceof History&&e.run()}}getCanvasPoint(t,e){const i=this.context2d.canvas,s=this.document.contentElement,n=this.document.headerElement;let o=t+s.scrollLeft-i.offsetParent.parentElement.offsetLeft-i.offsetParent.offsetLeft-i.offsetLeft,h=e+s.scrollTop-i.offsetParent.parentElement.offsetTop-i.offsetParent.offsetTop-i.offsetTop-n.offsetHeight;return point.x=o*i.width/i.clientWidth,point.y=h*i.height/i.clientHeight,point}get grabbing(){return _grabbing}set grabbing(t){_grabbing=t}onmousedown(t){if(this.grabbing)return;const e=this.getCanvasPoint(t.clientX,t.clientY),i=e.x,s=e.y;this.startPaint(i,s)}onmousemove(t){if(this.grabbing)return;const e=this.getCanvasPoint(t.clientX,t.clientY),i=e.x,s=e.y;this.paint(i,s)}onmouseup(t){this.grabbing||this.closePaint(t)}onmouseleave(t){this.grabbing||this.closePaint(t)}startPaint(t,e){this.undoStartFlag&&(this.undoStartFlag=!1,this.redoHistory.length=0),this.undoClearFlag&&(this.undoClearFlag=!1,this.redoHistory.length=0,this.undoHistory.length=0);const i=this.document;this.drag=!0;const s=this.context2dLayer,n=this.history=new History(s);s.save(),s.beginPath();const o=s.strokeStyle=this.lineColor,h=s.lineWidth=this.lineWidth,r=s.lineJoin=this.lineJoin,a=s.lineCap=this.lineCap,d=s.globalAlpha=this.opacityColorValue;this.history.addMethod("this.context2d.save();\n"),this.history.addMethod("this.context2d.beginPath();\n"),n.addProperty("this.context2d.strokeStyle",`'${o}'`),n.addProperty("this.context2d.lineWidth",`'${h}'`),n.addProperty("this.context2d.lineJoin",`'${r}'`),n.addProperty("this.context2d.lineCap",`'${a}'`),n.addProperty("this.context2d.globalAlpha",d),i.isHandEdit?this.startHandPaint(t,e):i.isArrowEdit?this.startArrowPaint(t,e):i.isLineEdit?this.startLinePaint(t,e):i.isDashedLineEdit?this.startDashedLinePaint(t,e):this.eraser&&this.startEraserPaint(t,e)}paint(t,e){if(this.drag){this.document.isHandEdit?this.handPaint(t,e):this.eraser&&this.eraserPaint(t,e)}}closePaint(t){if(this.drag){const t=this.context2dLayer,e=this.document,i=point.x,s=point.y;e.isHandEdit?this.closeHandPaint(i,s):e.isArrowEdit?this.closeArrowPaint(i,s):e.isLineEdit?this.closeLinePaint(i,s):e.isDashedLineEdit?this.closeDashedLinePaint(i,s):this.eraser&&this.closeEraserPaint(i,s),t.closePath(),t.restore(),this.history.addMethod("this.context2d.closePath();\n"),this.history.addMethod("this.context2d.restore();\n"),this.history&&(this.history.run=Function(this.history.str),this.undoHistory.push(this.history),this.history=null)}this.drag=!1}startHandPaint(t,e){this.context2dLayer.lineTo(t,e),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`)}handPaint(t,e){const i=this.context2dLayer;i.lineTo(t,e),i.stroke(),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`),this.history.addMethod("this.context2d.stroke();\n")}closeHandPaint(t,e){}startLinePaint(t,e){this.context2dLayer.lineTo(t,e),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`)}closeLinePaint(t,e){const i=this.context2dLayer;i.lineTo(t,e),i.stroke(),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`),this.history.addMethod("this.context2d.stroke();\n")}startDashedLinePaint(t,e){const i=this.context2dLayer;i.setLineDash([this.lineWidth,2*this.lineWidth]),i.lineTo(t,e),this.history.addMethod(`this.context2d.setLineDash([${this.lineWidth}, ${2*this.lineWidth}]);\n`),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`)}closeDashedLinePaint(t,e){const i=this.context2dLayer;i.lineTo(t,e),i.stroke(),i.setLineDash([]),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`),this.history.addMethod("this.context2d.stroke();\n"),this.history.addMethod("this.context2d.setLineDash([]);\n")}startArrowPaint(t,e){const i=this.context2dLayer;arrrowObject.x=t,arrrowObject.y=e,arrrowObject.start=!0,i.lineTo(t,e),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`)}closeArrowPaint(t,e){if(!arrrowObject.start)return;const i=this.context2dLayer,s=5*this.lineWidth,n=t-arrrowObject.x,o=e-arrrowObject.y,h=Math.atan2(o,n);i.lineTo(t,e),i.lineTo(t-s*Math.cos(h-Math.PI/6),e-s*Math.sin(h-Math.PI/6)),i.moveTo(t,e),i.lineTo(t-s*Math.cos(h+Math.PI/6),e-s*Math.sin(h+Math.PI/6)),i.stroke(),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`),this.history.addMethod(`this.context2d.lineTo(${t-s*Math.cos(h-Math.PI/6)}, ${e-s*Math.sin(h-Math.PI/6)});\n`),this.history.addMethod(`this.context2d.moveTo(${t},${e});\n`),this.history.addMethod(`this.context2d.lineTo(${t-s*Math.cos(h+Math.PI/6)}, ${e-s*Math.sin(h+Math.PI/6)});\n`),this.history.addMethod("this.context2d.stroke();\n"),arrrowObject.start=!1}startEraserPaint(t,e){const i=this.context2dLayer,s=this.eraserLength;i.clearRect(t,e,s,s),this.history.addMethod(`this.context2d.clearRect(${t}, ${e}, ${s}, ${s});\n`)}eraserPaint(t,e){const i=this.context2dLayer,s=this.eraserLength;i.clearRect(t,e,s,s),this.history.addMethod(`this.context2d.clearRect(${t}, ${e}, ${s}, ${s});\n`)}closeEraserPaint(t,e){}get lineColor(){return this.document.currentColor}get lineWidth(){return this.document.lineWidth}get lineCap(){return"round"}get lineJoin(){return"round"}get eraser(){return this.document.eraser}get eraserLength(){return 10*this.document.eraserLength}get opacityColorValue(){return this.document.opacityColorValue}clear(){const t=this.context2dLayer;t.save(),t.clearRect(0,0,this.width,this.height),t.restore()}clearCache(){this.undoClearFlag=!0,this.redoHistory.length=0,this.undoHistory.push(new Clean)}save(){const t=window.localStorage,e=JSON.stringify(this.undoHistory);t.setItem(this.documentTitle,e)}restore(){const t=window.localStorage.getItem(this.documentTitle),e=JSON.parse(t);if(e)for(let t=0,i=e.length;t<i;t++){const i=e[t],s=new History(this.context2dLayer);s.str=i.str,s.run=Function(s.str),this.undoHistory.push(s),s.run()}}get documentTitle(){return`${this.title}_${this.number}`}}class History{constructor(t){this.context2d=t,this.run=null,this.str=""}addProperty(t,e){this.str=this.str.concat(`${t}=${e};\n`)}addMethod(t){this.str=this.str.concat(`${t}\n`)}}class Clean{}