import Document from"./Document.js";import{UTIL}from"./util/Util.js";import Screenshot from"./Screenshot.js";import{justineDB}from"./JustineDB.js";const point={x:0,y:0},arrrowObject={x:0,y:0,start:!1};let lock=!1,_grabbing=!1;const storeName="page";export default class Page{constructor(t,e){this.document=null,this.pageElement=null,this.context2d=this.context2dLayer=null,this.pageObject=null,this.number=0,this.height=0,this.width=0,this.drag=!1;const s=window.document,i=s.createElement("div");i.tabIndex=-1,i.setAttribute("data-ld-src",`page-panel-${e.pageNumber}`);const n=s.createElement("span");n.style="position: relative; display:inline-block";const o=s.createElement("canvas");o.setAttribute("data-ld-src",`canvas-render-${e.pageNumber}`);const h=o.getContext("2d"),r=s.createElement("canvas");r.ontouchstart=t=>{const e=t.touches[0];t.preventDefault(),this.focus(),r.dispatchEvent(new MouseEvent("mousedown",{clientX:e.clientX,clientY:e.clientY}))},r.ontouchmove=t=>{const e=t.touches[0];t.preventDefault(),r.dispatchEvent(new MouseEvent("mousemove",{clientX:e.clientX,clientY:e.clientY}))},r.ontouchend=t=>{t.preventDefault(),r.dispatchEvent(new MouseEvent("mouseup",{}))},r.onmousedown=this.onmousedown.bind(this),r.onmouseup=this.onmouseup.bind(this),r.onmousemove=this.onmousemove.bind(this),r.onmouseleave=this.onmouseleave.bind(this),r.setAttribute("data-ld-src",`canvas-render-${e.pageNumber}`),r.style="position:absolute; left:0px; top: 0px;";const a=r.getContext("2d");n.appendChild(o),n.appendChild(r),i.appendChild(n),Object.defineProperties(this,{document:{get:()=>t},pageElement:{get:()=>i},context2d:{get:()=>h},context2dLayer:{get:()=>a},pageObject:{get:()=>e},number:{get:()=>e.pageNumber},pageIndex:{get:()=>e.pageIndex},height:{get:()=>o.height},width:{get:()=>o.width}}),this.scale=1,this.history=null,this.undoStartFlag=!1,this.undoClearFlag=!1,this.undoHistory=[],this.redoHistory=[],this.screenshot=new Screenshot(this),this.hidden()}show(){}hidden(){}focus(){this.pageElement.focus()}render(t){const e=this.pageObject;this.scale=t=Math.max(window.outerWidth/e.getViewport({scale:1}).width,e.getViewport({scale:1}).width/window.outerWidth);const s=e.getViewport({scale:.99*t.toFixed(1)}),i=this.context2d,n=i.canvas,o=this.context2dLayer.canvas;o.height=n.height=s.height,o.width=n.width=s.width;const h={canvasContext:i,viewport:s};e.render(h)}redo(){const t=this.redoHistory;if(t.length>0){if(lock)return;lock=!0;const e=t.pop();this.undoHistory.push(e),e.run(),lock=!1}else UTIL.alert("Não existem ações a serem refeitas")}undo(){const t=this.undoHistory;if(t.length>0){if(lock)return;lock=!0,this.undoClearFlag&&(this.undoClearFlag=!1);const e=t.pop();e instanceof Clean||(this.clear(),this.redoHistory.push(e),this.undoStartFlag=!0);for(const e of t)e.run();lock=!1}else UTIL.alert("Não existem ações a serem desfeitas")}update(){this.clear();for(let t=0,e=this.undoHistory.length;t<e;t++){const e=this.undoHistory[t];e instanceof History&&e.run()}}getCanvasPoint(t,e){const s=this.context2d.canvas,i=this.document.contentElement,n=this.document.headerElement;let o=t+i.scrollLeft-s.offsetParent.parentElement.offsetLeft-s.offsetParent.offsetLeft-s.offsetLeft,h=e+i.scrollTop-s.offsetParent.parentElement.offsetTop-s.offsetParent.offsetTop-s.offsetTop-n.offsetHeight;return point.x=o*s.width/s.clientWidth,point.y=h*s.height/s.clientHeight,point}get grabbing(){return _grabbing}set grabbing(t){_grabbing=t}onmousedown(t){if(this.grabbing)return;const e=this.getCanvasPoint(t.clientX,t.clientY),s=e.x,i=e.y;this.startPaint(s,i)}onmousemove(t){if(this.grabbing)return;const e=this.getCanvasPoint(t.clientX,t.clientY),s=e.x,i=e.y;this.paint(s,i)}onmouseup(t){this.grabbing||this.closePaint(t)}onmouseleave(t){this.grabbing||this.closePaint(t)}startPaint(t,e){this.undoStartFlag&&(this.undoStartFlag=!1,this.redoHistory.length=0),this.undoClearFlag&&(this.undoClearFlag=!1,this.redoHistory.length=0,this.undoHistory.length=0);const s=this.document;this.drag=!0;const i=this.context2dLayer,n=this.history=new History(i);i.save(),i.beginPath();const o=i.strokeStyle=this.lineColor,h=i.lineWidth=this.lineWidth,r=i.lineJoin=this.lineJoin,a=i.lineCap=this.lineCap,d=i.globalAlpha=this.opacityColorValue;this.history.addMethod("this.context2d.save();\n"),this.history.addMethod("this.context2d.beginPath();\n"),n.addProperty("this.context2d.strokeStyle",`'${o}'`),n.addProperty("this.context2d.lineWidth",`'${h}'`),n.addProperty("this.context2d.lineJoin",`'${r}'`),n.addProperty("this.context2d.lineCap",`'${a}'`),n.addProperty("this.context2d.globalAlpha",d),s.isHandEdit?this.startHandPaint(t,e):s.isArrowEdit?this.startArrowPaint(t,e):s.isLineEdit?this.startLinePaint(t,e):s.isDashedLineEdit?this.startDashedLinePaint(t,e):this.eraser&&this.startEraserPaint(t,e)}paint(t,e){if(this.drag){this.document.isHandEdit?this.handPaint(t,e):this.eraser&&this.eraserPaint(t,e)}}closePaint(t){if(this.drag){const t=this.context2dLayer,e=this.document,s=point.x,i=point.y;e.isHandEdit?this.closeHandPaint(s,i):e.isArrowEdit?this.closeArrowPaint(s,i):e.isLineEdit?this.closeLinePaint(s,i):e.isDashedLineEdit?this.closeDashedLinePaint(s,i):this.eraser&&this.closeEraserPaint(s,i),t.closePath(),t.restore(),this.history.addMethod("this.context2d.closePath();\n"),this.history.addMethod("this.context2d.restore();\n"),this.history&&(this.history.run=Function(this.history.str),this.undoHistory.push(this.history),this.history=null)}this.drag=!1}startHandPaint(t,e){this.context2dLayer.lineTo(t,e),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`)}handPaint(t,e){const s=this.context2dLayer;s.lineTo(t,e),s.stroke(),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`),this.history.addMethod("this.context2d.stroke();\n")}closeHandPaint(t,e){}startLinePaint(t,e){this.context2dLayer.lineTo(t,e),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`)}closeLinePaint(t,e){const s=this.context2dLayer;s.lineTo(t,e),s.stroke(),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`),this.history.addMethod("this.context2d.stroke();\n")}startDashedLinePaint(t,e){const s=this.context2dLayer;s.setLineDash([this.lineWidth,2*this.lineWidth]),s.lineTo(t,e),this.history.addMethod(`this.context2d.setLineDash([${this.lineWidth}, ${2*this.lineWidth}]);\n`),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`)}closeDashedLinePaint(t,e){const s=this.context2dLayer;s.lineTo(t,e),s.stroke(),s.setLineDash([]),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`),this.history.addMethod("this.context2d.stroke();\n"),this.history.addMethod("this.context2d.setLineDash([]);\n")}startArrowPaint(t,e){const s=this.context2dLayer;arrrowObject.x=t,arrrowObject.y=e,arrrowObject.start=!0,s.lineTo(t,e),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`)}closeArrowPaint(t,e){if(!arrrowObject.start)return;const s=this.context2dLayer,i=5*this.lineWidth,n=t-arrrowObject.x,o=e-arrrowObject.y,h=Math.atan2(o,n);s.lineTo(t,e),s.lineTo(t-i*Math.cos(h-Math.PI/6),e-i*Math.sin(h-Math.PI/6)),s.moveTo(t,e),s.lineTo(t-i*Math.cos(h+Math.PI/6),e-i*Math.sin(h+Math.PI/6)),s.stroke(),this.history.addMethod(`this.context2d.lineTo(${t},${e});\n`),this.history.addMethod(`this.context2d.lineTo(${t-i*Math.cos(h-Math.PI/6)}, ${e-i*Math.sin(h-Math.PI/6)});\n`),this.history.addMethod(`this.context2d.moveTo(${t},${e});\n`),this.history.addMethod(`this.context2d.lineTo(${t-i*Math.cos(h+Math.PI/6)}, ${e-i*Math.sin(h+Math.PI/6)});\n`),this.history.addMethod("this.context2d.stroke();\n"),arrrowObject.start=!1}startEraserPaint(t,e){const s=this.context2dLayer,i=this.eraserLength;s.clearRect(t,e,i,i),this.history.addMethod(`this.context2d.clearRect(${t}, ${e}, ${i}, ${i});\n`)}eraserPaint(t,e){const s=this.context2dLayer,i=this.eraserLength;s.clearRect(t,e,i,i),this.history.addMethod(`this.context2d.clearRect(${t}, ${e}, ${i}, ${i});\n`)}closeEraserPaint(t,e){}get lineColor(){return this.document.currentColor}get lineWidth(){return this.document.lineWidth}get lineCap(){return"round"}get lineJoin(){return"round"}get eraser(){return this.document.eraser}get eraserLength(){return 10*this.document.eraserLength}get opacityColorValue(){return this.document.opacityColorValue}clear(){const t=this.context2dLayer;t.save(),t.clearRect(0,0,this.width,this.height),t.restore()}clearCache(){this.undoClearFlag=!0,this.redoHistory.length=0,this.undoHistory.push(new Clean)}save(){const t=JSON.stringify(this.undoHistory);justineDB.save("page",this.documentTitle,t)}delete(){justineDB.delete("page",this.documentTitle)}restore(){justineDB.find("page",this.documentTitle,(t=>{const e=JSON.parse(t);if(e)for(let t=0,s=e.length;t<s;t++){const s=e[t],i=new History(this.context2dLayer);i.str=s.str,i.run=Function(i.str),this.undoHistory.push(i),i.run()}}))}get documentTitle(){return`${this.document.title}${this.number+1?`_${this.number}`:""}`}}class History{constructor(t){this.context2d=t,this.run=null,this.str=""}addProperty(t,e){this.str=this.str.concat(`${t}=${e};\n`)}addMethod(t){this.str=this.str.concat(`${t}\n`)}}class Clean{}